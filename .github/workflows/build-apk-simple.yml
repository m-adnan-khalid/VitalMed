name: Build VitalMed Pro APK (Simplified)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ“‹ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ—„ï¸ Cache Flutter
      uses: actions/cache@v3
      with:
        path: |
          /opt/hostedtoolcache/flutter
          ~/.pub-cache
        key: flutter-${{ runner.os }}-3.38.3
        restore-keys: flutter-${{ runner.os }}-
        
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools-version: 34.0.0
        ndk-version: 25.1.8937393
        
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.3'
        channel: 'stable'
        cache: true
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        flutter --version
        flutter pub get
        
    - name: ğŸ“ Accept Android Licenses
      run: |
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
        yes | sdkmanager --licenses || echo "License acceptance completed"
        
    - name: ğŸ” Flutter Doctor Check
      run: flutter doctor -v
      
    - name: ğŸ”¨ Generate Code Files
      run: |
        echo "Generating required code files..."
        flutter packages pub run build_runner build --delete-conflicting-outputs || echo "Code generation completed with warnings"
        
    - name: ğŸ§¹ Clean Build Cache
      run: flutter clean
      
    - name: ğŸ“¦ Get Dependencies Again
      run: flutter pub get
        
    - name: âœ… Analyze Code
      run: flutter analyze --no-fatal-infos || echo "Analysis completed with warnings"
      
    - name: ğŸ”¨ Build Debug APK
      run: |
        echo "ğŸ—ï¸ Building VitalMed Pro Debug APK..."
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        flutter build apk --debug --split-per-abi
        echo "âœ… Debug APK build completed"
        
    - name: ğŸ”¨ Build Release APK
      run: |
        echo "ğŸ—ï¸ Building VitalMed Pro Release APK..."
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        flutter build apk --release --split-per-abi
        echo "âœ… Release APK build completed"
        
    - name: ğŸ“Š List Generated APKs
      run: |
        echo "ğŸ“± Generated APK files:"
        find build/app/outputs/flutter-apk/ -name "*.apk" -exec ls -lh {} \;
        echo ""
        echo "ğŸ“‚ APK directory structure:"
        ls -la build/app/outputs/flutter-apk/
        
    - name: ğŸ“¤ Upload Debug APKs
      uses: actions/upload-artifact@v4
      with:
        name: vitalmed-debug-apks
        path: |
          build/app/outputs/flutter-apk/app-debug.apk
          build/app/outputs/flutter-apk/app-arm64-v8a-debug.apk
          build/app/outputs/flutter-apk/app-armeabi-v7a-debug.apk
          build/app/outputs/flutter-apk/app-x86_64-debug.apk
        retention-days: 30
        if-no-files-found: warn
        
    - name: ğŸ“¤ Upload Release APKs
      uses: actions/upload-artifact@v4
      with:
        name: vitalmed-release-apks
        path: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
          build/app/outputs/flutter-apk/app-x86_64-release.apk
        retention-days: 30
        if-no-files-found: warn
        
    - name: ğŸ“ Create Build Summary
      run: |
        echo "# ğŸ‰ VitalMed Pro APK Build Complete!" > build-summary.md
        echo "" >> build-summary.md
        echo "## ğŸ“± Build Information" >> build-summary.md
        echo "- **Build Date:** $(date)" >> build-summary.md
        echo "- **Flutter Version:** $(flutter --version | head -1)" >> build-summary.md
        echo "- **Commit Hash:** ${{ github.sha }}" >> build-summary.md
        echo "- **Branch:** ${{ github.ref_name }}" >> build-summary.md
        echo "" >> build-summary.md
        echo "## ğŸ“± Generated APK Files" >> build-summary.md
        echo "### Debug APKs (for testing):" >> build-summary.md
        echo "- Universal Debug APK (\`app-debug.apk\`)" >> build-summary.md
        echo "- ARM64 Debug APK (\`app-arm64-v8a-debug.apk\`) - For modern devices" >> build-summary.md
        echo "- ARMv7 Debug APK (\`app-armeabi-v7a-debug.apk\`) - For older devices" >> build-summary.md
        echo "- x86_64 Debug APK (\`app-x86_64-debug.apk\`) - For emulators" >> build-summary.md
        echo "" >> build-summary.md
        echo "### Release APKs (optimized):" >> build-summary.md
        echo "- Universal Release APK (\`app-release.apk\`)" >> build-summary.md
        echo "- ARM64 Release APK (\`app-arm64-v8a-release.apk\`) - For modern devices" >> build-summary.md
        echo "- ARMv7 Release APK (\`app-armeabi-v7a-release.apk\`) - For older devices" >> build-summary.md
        echo "- x86_64 Release APK (\`app-x86_64-release.apk\`) - For emulators" >> build-summary.md
        echo "" >> build-summary.md
        echo "## ğŸ“‹ Installation Instructions" >> build-summary.md
        echo "1. Download the appropriate APK from the artifacts section above" >> build-summary.md
        echo "2. For most devices, use the Universal APK (\`app-release.apk\`)" >> build-summary.md
        echo "3. Enable 'Unknown Sources' on your Android device" >> build-summary.md
        echo "4. Install the APK and grant required permissions" >> build-summary.md
        echo "5. Launch VitalMed Pro and start monitoring your health!" >> build-summary.md
        echo "" >> build-summary.md
        echo "## ğŸ” Required Permissions" >> build-summary.md
        echo "- **Bluetooth** - Connect to health devices" >> build-summary.md
        echo "- **Location** - Required for Bluetooth scanning" >> build-summary.md
        echo "- **Storage** - Save health measurements" >> build-summary.md
        echo "" >> build-summary.md
        echo "## ğŸ“Š APK Details" >> build-summary.md
        echo "\`\`\`" >> build-summary.md
        find build/app/outputs/flutter-apk/ -name "*.apk" -exec ls -lh {} \; >> build-summary.md
        echo "\`\`\`" >> build-summary.md
        echo "" >> build-summary.md
        echo "ğŸ¯ **Your VitalMed Pro APK is ready for real-world health monitoring!**" >> build-summary.md
        
    - name: ğŸ“¤ Upload Build Summary
      uses: actions/upload-artifact@v4
      with:
        name: vitalmed-build-summary
        path: build-summary.md
        retention-days: 30

  notify:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ‰ Build Success
      if: needs.build.result == 'success'
      run: |
        echo "ğŸ‰ VitalMed Pro APK built successfully!"
        echo "ğŸ“± Multiple APK variants available for different device architectures"
        echo "ğŸ”— Download from: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ğŸ“‹ Next Steps:"
        echo "1. Download the Universal Release APK for most devices"
        echo "2. Install on your Android phone (5.0+)"
        echo "3. Grant Bluetooth and Location permissions"
        echo "4. Connect your health monitoring devices"
        echo "5. Start real-time health monitoring with VitalMed Pro!"
        
    - name: âŒ Build Failed
      if: needs.build.result == 'failure'
      run: |
        echo "âŒ VitalMed Pro APK build failed!"
        echo "ğŸ” Check the build logs for details"
        echo "ğŸ”— Build URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ğŸ’¡ Common solutions:"
        echo "- Check Flutter version compatibility"
        echo "- Verify all dependencies are available"
        echo "- Review code generation steps"
        echo "- Check Android SDK requirements"